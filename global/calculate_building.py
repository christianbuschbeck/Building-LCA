# -*- coding: utf-8 -*-
"""
Created on Tue May 25 10:49:10 2021

@author: cbuschbeck
"""

def calculate_building(BIM,
                       comp,
                       serv,
                       all_component_names,
                       selection_component_names,
                       all_services_names,
                       selection_bauservices_names,
                       selection_energieservices_names,
                       wd_grob,
                       modulespath,
                       aufwand_abbau,
                       aufwand_aufbau,
                       moduleselection=False):

    import sys
    sys.path.append("C:/Schaffeschaffe/Holzhybrid/skripte/global/")
    from RUNALL import runall
    from calculate import calculate_res
    
    gebaeude_in  = BIM["phase"].tolist().index("gebaeude_in")
    austausch    = BIM["phase"].tolist().index("austausch")
    umbau_in     = BIM["phase"].tolist().index("umbau_in")
    umbau_out    = BIM["phase"].tolist().index("umbau_out")
    gebaeude_out = BIM["phase"].tolist().index("gebaeude_out")
    huelle       = BIM["phase"].tolist().index("huelle")

    
    #######################
    ## Calculation      ###
    #######################
    
    
    #Herstellung 
    modules = ["A1-A3","A4"]
    if moduleselection != False:
        m1 = set(modules)
        m2 = set(moduleselection)
        modules = list(m1.intersection(m2))
    
    print("Herstellung:"+ "".join(modules))        
        
    for m in selection_component_names:
        
        wd = wd_grob + m
        
        if m == "" or "".join(modules) =="":
            continue
        print("Component / Service:" + m)
        
        MENGE = float(BIM.loc[gebaeude_in,m])
        
        raus   = float(BIM.loc[umbau_out,m])
        rueber = float(BIM.loc[gebaeude_in,m]) - raus
        rausrueber = raus + rueber
        if rausrueber == 0:
            rausrueber = 1            
        RB     = ((float(comp.loc[comp.loc[:,"vars"]=="rueckbau1",m]) *raus ) + (float(comp.loc[comp.loc[:,"vars"]=="rueckbau2",m])*rueber)) / (rausrueber)
        
        if MENGE == 0:
            for n in modules:
                calculate_res("dummy",wd=wd,filename=n)
            continue
       
        for col in all_component_names:
            comp.loc[comp.loc[:,"vars"]=="include",col] = 0
            comp.loc[comp.loc[:,"vars"]=="rueckbau",col] = 0
            
        comp.loc[comp.loc[:,"vars"]=="include",m]  = MENGE
        comp.loc[comp.loc[:,"vars"]=="rueckbau",m] = RB
        
        comp.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/components.csv",index=False,sep=";")
        comp.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
                
        runall(modules=modules,modulespath=modulespath,wd=wd,ECOINV=True)
    
    
    #EOL
    modules = ["C2","C3","C4"]
    
    if moduleselection != False:
        m1 = set(modules)
        m2 = set(moduleselection)
        modules = list(m1.intersection(m2))
     
    print("EOL:"+ "".join(modules))
    
    for m in selection_component_names:
        
        wd = wd_grob + m
        
        if m == "" or "".join(modules) =="":
            continue
        print("Component / Service:" + m)
        
        MENGE =  float(BIM.loc[gebaeude_out,m])
        
        if MENGE == 0:
            for n in modules:
                calculate_res("dummy",wd=wd,filename=n)
            continue
    
        
        for col in all_component_names:
            comp.loc[comp.loc[:,"vars"]=="include",col] = 0
            comp.loc[comp.loc[:,"vars"]=="rueckbau",col] = 0
        comp.loc[comp.loc[:,"vars"]=="include",m] = MENGE
        comp.loc[comp.loc[:,"vars"]=="rueckbau",m] = float(comp.loc[comp.loc[:,"vars"]=="rueckbau2",m])
        comp.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/components.csv",index=False,sep=";")
        comp.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
        
        runall(modules=modules,modulespath=modulespath,wd=wd,ECOINV=True)
    
    
    #Auf- und Abbau
    modules = ["A5","C1"]
    
    if moduleselection != False:
        m1 = set(modules)
        m2 = set(moduleselection)
        modules = list(m1.intersection(m2))
     
    print("Aufab:"+ "".join(modules))        
    
    for m in selection_bauservices_names:
        
        wd = wd_grob + m
       
        if m == "" or "".join(modules) =="":
            continue
        print("Component / Service:" + m)
        
        stuetze_rb = BIM.loc[gebaeude_out,"stuetze_rb"] / BIM.loc[gebaeude_out,"stuetze"]
        wand_rb = BIM.loc[gebaeude_out,"wand_rb"] / BIM.loc[gebaeude_out,"wand"]
        decke_rb = BIM.loc[gebaeude_out,"decke_rb"] / BIM.loc[gebaeude_out,"decke"]
        
        aufbau = float(BIM.loc[gebaeude_in,"stuetze"]) * float(aufwand_aufbau.loc[aufwand_aufbau.loc[:,"vars"]==m,"Stütze"]) + \
                 float(BIM.loc[gebaeude_in,"decke"]) * float(aufwand_aufbau.loc[aufwand_aufbau.loc[:,"vars"]==m,"Decke"]) + \
                 float(BIM.loc[gebaeude_in,"wand"]) * float(aufwand_aufbau.loc[aufwand_aufbau.loc[:,"vars"]==m,"Wand"]) + \
                 float(BIM.loc[gebaeude_in,"fundament"]) * float(aufwand_aufbau.loc[aufwand_aufbau.loc[:,"vars"]==m,"Aushub"]) * 2 + \
                 float(BIM.loc[gebaeude_in,"fundament"]) * float(aufwand_aufbau.loc[aufwand_aufbau.loc[:,"vars"]==m,"Fundament"])
                     
        abbau =  stuetze_rb* float(BIM.loc[gebaeude_out,"stuetze"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Stütze"]) + \
                 decke_rb* float(BIM.loc[gebaeude_out,"decke"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Decke"]) + \
                 wand_rb* float(BIM.loc[gebaeude_out,"wand"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Wand"]) 
        
        if m =="bagger":
            abriss =  (1-stuetze_rb)* float(BIM.loc[gebaeude_out,"stuetze"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Stütze_abriss"]) + \
                      (1-decke_rb)  * float(BIM.loc[gebaeude_out,"decke"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Decke_abriss"]) + \
                      (1-wand_rb)   * float(BIM.loc[gebaeude_out,"wand"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Wand_abriss"]) + \
                                      float(BIM.loc[gebaeude_out,"fundament"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Fundament"]) 
            abbau = abbau + abriss         
        
        
        if aufbau + abbau == 0:
            for n in modules:
                calculate_res("dummy",wd=wd,filename=n)
            continue
               
        for col in all_services_names:
            serv.loc[serv.loc[:,"vars"]=="include",col] = 0
            serv.loc[serv.loc[:,"vars"]=="aufbau",col] = 0
            serv.loc[serv.loc[:,"vars"]=="abbau",col] = 0
        serv.loc[serv.loc[:,"vars"]=="aufbau",m] = aufbau
        serv.loc[serv.loc[:,"vars"]=="abbau",m] = abbau
        serv.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/services.csv",index=False,sep=";")
        serv.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
               
        runall(modules=modules,modulespath=modulespath,wd=wd,ECOINV=True)
    
    # Nutzung

    modules = ["B1"]
    
    if moduleselection != False:
        m1 = set(modules)
        m2 = set(moduleselection)
        modules = list(m1.intersection(m2))
     
    print("Nutzung:"+ "".join(modules))
    
    for m in selection_component_names:
        
        wd = wd_grob + m
        
        if m != "concrete":
            continue
                
        print("Component / Service:" + m)
        
        excessmenge = float(BIM.loc[umbau_in,m]) - float(BIM.loc[umbau_out,m])
        
        MENGE =  float(BIM.loc[gebaeude_out,m]) - excessmenge + excessmenge/2   #Das was beim Umbau rausgeht, ist konnte nur die 
            
        if MENGE == 0:
            for n in modules:
                calculate_res("dummy",wd=wd,filename=n)
            continue
        
        for col in all_component_names:
            comp.loc[comp.loc[:,"vars"]=="include",col] = 0
        comp.loc[comp.loc[:,"vars"]=="include",m] = MENGE
        comp.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/components.csv",index=False,sep=";")
        comp.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
        
        runall(modules=modules,modulespath=modulespath,wd=wd,ECOINV=True)
 
    # Instandsetzung

    modules = ["B2"]
    
    if moduleselection != False:
        m1 = set(modules)
        m2 = set(moduleselection)
        modules = list(m1.intersection(m2))
     
    print("Nutzung:"+ "".join(modules))
    
    for m in selection_component_names:
        
        wd = wd_grob + m
        
        if m not in ["osb"] :
            continue
                
        print("Component / Service:" + m)
        #!!! Achtung hier wird osb als einizges als Fläche nicht Volumen behandelt 

        MENGE =  float(BIM.loc[huelle,m])
            
        if MENGE == 0:
            for n in modules:
                calculate_res("dummy",wd=wd,filename=n)
            continue
        
        for col in all_component_names:
            comp.loc[comp.loc[:,"vars"]=="include",col] = 0
        comp.loc[comp.loc[:,"vars"]=="include",m] = MENGE
        comp.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/components.csv",index=False,sep=";")
        comp.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
        
        runall(modules=modules,modulespath=modulespath,wd=wd,ECOINV=True)
    
    
    # Austausch
 
    
    modules = ["B4"]
    
    if moduleselection != False:
        m1 = set(modules)
        m2 = set(moduleselection)
        modules = list(m1.intersection(m2))
    
    print("Austausch:"+ "".join(modules))                
    
    for m in list(selection_component_names) + list(selection_bauservices_names):
        
        wd = wd_grob + m
        
        abbau = 0 
        aufbau = 0
        MENGE = 0
        
        if m == "" or "".join(modules) =="":
            continue
        print("Component / Service:" + m)
            
        if m in selection_component_names:
            
            MENGE = float(BIM.loc[austausch,m])
        
        if m in selection_bauservices_names:
            
            abbau = float(BIM.loc[austausch,"stuetze"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Stütze"]) + \
                    float(BIM.loc[austausch,"decke"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Decke"]) + \
                    float(BIM.loc[austausch,"wand"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Wand"]) 

            aufbau = float(BIM.loc[austausch,"stuetze"]) * float(aufwand_aufbau.loc[aufwand_aufbau.loc[:,"vars"]==m,"Stütze"]) + \
                     float(BIM.loc[austausch,"decke"]) * float(aufwand_aufbau.loc[aufwand_aufbau.loc[:,"vars"]==m,"Decke"]) + \
                     float(BIM.loc[austausch,"wand"]) * float(aufwand_aufbau.loc[aufwand_aufbau.loc[:,"vars"]==m,"Wand"]) 
    
        if MENGE + abbau + aufbau == 0:
            for n in modules:
                calculate_res("dummy",wd=wd,filename=n)
            continue
                  
        for col in all_component_names:
            comp.loc[comp.loc[:,"vars"]=="include",col] = 0
        
        if MENGE > 0:            
            comp.loc[comp.loc[:,"vars"]=="include",m] = MENGE
            comp.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
                
        for col in all_services_names:
            serv.loc[serv.loc[:,"vars"]=="include",col] = 0
            serv.loc[serv.loc[:,"vars"]=="aufbau",col] = 0
            serv.loc[serv.loc[:,"vars"]=="abbau",col] = 0

        if abbau > 0:            
            serv.loc[serv.loc[:,"vars"]=="abbau",m] = abbau           
            serv.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario

        if aufbau > 0:   
            serv.loc[serv.loc[:,"vars"]=="aufbau",m] = aufbau
            serv.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
        
        comp.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/components.csv",index=False,sep=";")        
        serv.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/services.csv",index=False,sep=";")                
        
        runall(modules=modules,modulespath=modulespath,wd=wd,ECOINV=True)
    

    
    #Umbau
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
    
    modules = ["B5_out"]
    
    if moduleselection != False:
        m1 = set(modules)
        m2 = set(moduleselection)
        modules = list(m1.intersection(m2))
    
    print("Umbau:"+ "".join(modules))                
    
    for m in list(selection_component_names) + list(selection_bauservices_names):
        
        wd = wd_grob + m
        
        abbau = 0 
        MENGE = 0
        
        if m == "" or "".join(modules) =="":
            continue
        print("Component / Service:" + m)
            
        if m in selection_component_names:
            
            MENGE = float(BIM.loc[umbau_out,m])
        
        if m in selection_bauservices_names:
                       
            stuetze_rb = BIM.loc[gebaeude_out,"stuetze_rb"] / BIM.loc[gebaeude_out,"stuetze"]
            wand_rb = BIM.loc[gebaeude_out,"wand_rb"] / BIM.loc[gebaeude_out,"wand"]
            decke_rb = BIM.loc[gebaeude_out,"decke_rb"] / BIM.loc[gebaeude_out,"decke"]
                   
            abbau =  stuetze_rb* float(BIM.loc[gebaeude_out,"stuetze"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Stütze"]) + \
                decke_rb* float(BIM.loc[gebaeude_out,"decke"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Decke"]) + \
                wand_rb* float(BIM.loc[gebaeude_out,"wand"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Wand"]) 
        
            if m =="bagger":
                abriss =  (1-stuetze_rb)* float(BIM.loc[gebaeude_out,"stuetze"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Stütze_abriss"]) + \
                      (1-decke_rb)  * float(BIM.loc[gebaeude_out,"decke"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Decke_abriss"]) + \
                      (1-wand_rb)   * float(BIM.loc[gebaeude_out,"wand"]) * float(aufwand_abbau.loc[aufwand_abbau.loc[:,"vars"]==m,"Wand_abriss"]) 
                abbau = abbau + abriss
    
        if MENGE + abbau == 0:
            for n in modules:
                calculate_res("dummy",wd=wd,filename=n)
            continue
                  
        for col in all_component_names:
            comp.loc[comp.loc[:,"vars"]=="include",col] = 0
            comp.loc[comp.loc[:,"vars"]=="rueckbau",col] = 0
        
        if MENGE > 0:            
            comp.loc[comp.loc[:,"vars"]=="include",m] = MENGE
            comp.loc[comp.loc[:,"vars"]=="rueckbau",m] = float(comp.loc[comp.loc[:,"vars"]=="rueckbau1",m])
            comp.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
                
        for col in all_services_names:
            serv.loc[serv.loc[:,"vars"]=="include",col] = 0
            serv.loc[serv.loc[:,"vars"]=="aufbau",col] = 0
            serv.loc[serv.loc[:,"vars"]=="abbau",col] = 0

        if abbau > 0:            
            serv.loc[serv.loc[:,"vars"]=="abbau",m] = abbau           
            serv.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
                
        comp.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/components.csv",index=False,sep=";")        
        serv.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/services.csv",index=False,sep=";")                
        
        runall(modules=modules,modulespath=modulespath,wd=wd,ECOINV=True)
    
    
    
    modules = ["B5_in"]
    
    if moduleselection != False:
        m1 = set(modules)
        m2 = set(moduleselection)
        modules = list(m1.intersection(m2))
    
    print("Umbau:"+ "".join(modules))                 
    
    for m in list(selection_component_names) + list(selection_bauservices_names):

        wd = wd_grob + m        
        
        aufbau = 0
        MENGE  = 0
        
        if m == "" or "".join(modules) =="":
            continue
        print("Component / Service:" + m)
        
        if m in selection_component_names:
            MENGE = float(BIM.loc[umbau_in,m])
      
        if m in selection_bauservices_names:
            
            aufbau = float(BIM.loc[umbau_in,"stuetze"]) * float(aufwand_aufbau.loc[aufwand_aufbau.loc[:,"vars"]==m,"Stütze"]) + \
                     float(BIM.loc[umbau_in,"decke"]) * float(aufwand_aufbau.loc[aufwand_aufbau.loc[:,"vars"]==m,"Decke"]) + \
                     float(BIM.loc[umbau_in,"wand"]) * float(aufwand_aufbau.loc[aufwand_aufbau.loc[:,"vars"]==m,"Wand"]) 
        
        if MENGE + aufbau == 0:
            for n in modules:
                calculate_res("dummy",wd=wd,filename=n)
            continue
                   
        for col in all_services_names:
            serv.loc[serv.loc[:,"vars"]=="include",col] = 0
            serv.loc[serv.loc[:,"vars"]=="aufbau",col] = 0
            serv.loc[serv.loc[:,"vars"]=="abbau",col] = 0
        
        if aufbau > 0:   
            serv.loc[serv.loc[:,"vars"]=="aufbau",m] = aufbau
            serv.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
                              
        for col in all_component_names:
            comp.loc[comp.loc[:,"vars"]=="include",col] = 0
            comp.loc[comp.loc[:,"vars"]=="rueckbau",col] = 0
        
        if MENGE > 0:                    
            comp.loc[comp.loc[:,"vars"]=="include",m]  = MENGE
            comp.loc[comp.loc[:,"vars"]=="rueckbau",m] = float(comp.loc[comp.loc[:,"vars"]=="rueckbau2",m])
            comp.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
                
        comp.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/components.csv",index=False,sep=";")
        serv.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/services.csv",index=False,sep=";")
        
        runall(modules=modules,modulespath=modulespath,wd=wd,ECOINV=True)
    
    
    
    
    
    
    #Energie
    
    modules = ["B6_wohn","B6_park","D_e_g","D_e_k"]
    
    if moduleselection != False:
        m1 = set(modules)
        m2 = set(moduleselection)
        modules = list(m1.intersection(m2))
     
    print("Energie:"+ "".join(modules))                         
    
    for m in selection_energieservices_names:
        
        if m == "" or "".join(modules) =="":
            continue
        print("Component / Service:" + m)
        
        for col in all_component_names:
            comp.loc[comp.loc[:,"vars"]=="include",col] = 0
        for col in all_services_names:
            serv.loc[serv.loc[:,"vars"]=="include",col] = 0
    
        serv.loc[serv.loc[:,"vars"]=="include",m] = 25
    
        serv.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/services.csv",index=False,sep=";")
        comp.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/components.csv",index=False,sep=";")
        
        wd = wd_grob + m
        runall(modules=modules,modulespath=modulespath,wd=wd,ECOINV=True)
    
    serv.loc[serv.loc[:,"vars"]=="ee","strom"] = 0
    serv.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/services.csv",index=False,sep=";")
    
    # Vorteile und Lasten außerhalb
    
    modules = ["D_e_g","D_e_k","D_s_g","D_s_k","D_w_g","D_w_k"]
    
    if moduleselection != False:
        m1 = set(modules)
        m2 = set(moduleselection)
        modules = list(m1.intersection(m2))
     
    print("Vorteile und Lasten:"+ "".join(modules))                        
    
    for m in selection_component_names:
        
        wd = wd_grob + m
        
        if m == "" or "".join(modules) =="":
            continue
        print("Component / Service:" + m)
        
        MENGE = float(BIM.loc[[gebaeude_out,umbau_out],m].sum())
        if MENGE == 0:
            for n in modules:
                calculate_res("dummy",wd=wd,filename=n)
            continue
        
        raus   = float(BIM.loc[umbau_out,m])
        ab     = float(BIM.loc[gebaeude_out,m])
        RB     = ((float(comp.loc[comp.loc[:,"vars"]=="rueckbau1",m]) *raus ) + (float(comp.loc[comp.loc[:,"vars"]=="rueckbau2",m])*ab)) / (raus+ab)
        
        
        for col in all_component_names:
            comp.loc[comp.loc[:,"vars"]=="include",col] = 0
            comp.loc[comp.loc[:,"vars"]=="rueckbau",col] = 0
        comp.loc[comp.loc[:,"vars"]=="include",m]  = MENGE
        comp.loc[comp.loc[:,"vars"]=="rueckbau",m] = RB
        comp.to_csv("C:/Schaffeschaffe/Holzhybrid/daten/forprogramming/components.csv",index=False,sep=";")
        comp.to_csv(wd_grob+"/_scen/"+m + "".join(modules) + ".csv",index=False,sep=";") # Szenario
                
        runall(modules=modules,modulespath=modulespath,wd=wd,ECOINV=True)
    
